//定义 gitlab的凭证ID

def git_auth = "8a643656-f20c-4837-a6bb-f3f5074c95ad"
               
//定义 gitlab的url地址
def git_url = "git@192.168.110.100:itheima_group/tensquare_back.git"

//镜像版本号
def tag = "latest"

//定义Harbor的url地址
def harbor_url = "192.168.110.204:85"

//镜像库项目名称
def harbor_project = "tensquare"

           
node {
  stage('拉取代码') {
	  checkout scmGit(branches: [[name: "*/${branch}"]], 
	                  extensions: [], userRemoteConfigs: [[credentialsId: "${git_auth}", url: "${git_url}"]])
		   										 
  }
  
  stage('代码审查'){
      //定义当前Jenkins的SonarQubeScanner工具
      def scannerHome = tool 'sonar-scanner'
      //引用当前JenkinsSonarQube环境
      withSonarQubeEnv('sonarqube'){
         sh """
             cd tensquare_parent/${project_name}
             
             ${scannerHome}/bin/sonar-scanner
             
            """
      }
  }
  
  stage('编译，安装公共子工程'){
      sh "mvn -f tensquare_parent/tensquare_common clean install"
  
  }
  
  stage('编译，打包微服务工程，上传镜像'){
  
      //sh "mvn -f tensquare_parent clean package"
  
      sh "mvn -f tensquare_parent/${project_name} clean package dockerfile:build"
  
      //定义镜像名称
      def imageName = "${project_name}:${tag}"
      
      //对镜像打上标签
      sh "docker tag ${imageName} ${harbor_url}/${harbor_project}/${imageName}"
      
  }
      
}